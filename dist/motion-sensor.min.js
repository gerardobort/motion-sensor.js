!function(a,b){var c=function(a){this.options=a,this.canvas=b.createElement("canvas"),this.canvas.style.webkitTransform="scaleX(-1)",this.video=b.createElement("video"),this.video.autoplay="true",this.video.style.display="none",this.setScale(a.initialScale||.35);var c=b.getElementsByTagName("body")[0];if(c.appendChild(this.canvas),c.appendChild(this.video),this.canvasContext=this.canvas.getContext("2d"),a.totalBuffers<2)throw"MotionSensor: Wrong setting: totalBuffers must be 2 or higher.";a.totalBuffers<3&&console.log("MotionSensor: Warning: It's not possible to compute cluster directions when using 2 buffers."),this.imageDataBuffersN=a.totalBuffers,this.imageDataBuffers=[];for(var d=0,e=this.imageDataBuffersN;e>d;d++)this.imageDataBuffers.push(this.canvasContext.createImageData(this.VIDEO_WIDTH,this.VIDEO_HEIGHT));this.attachedEvents={},this.processorConstructor=a.processor||this.constructor.Processor,this.performanceController=new this.constructor.PerformanceController(this)};c.prototype.start=function(){var a=this;a.processor=new a.processorConstructor(a),navigator.webkitGetUserMedia({video:!0},function(b){a.video.src=webkitURL.createObjectURL(b),webkitRequestAnimationFrame(a.updateCanvas.bind(a)),console.log("MotionSensor started."),a.trigger("start",[a.canvas,a.canvasContext])},function(){throw"MotionSensor error during webcam initialization."})},c.prototype.setScale=function(a){this.scale=a,this.VIDEO_WIDTH=640*this.scale,this.VIDEO_HEIGHT=480*this.scale,this.canvas.width=this.VIDEO_WIDTH,this.canvas.height=this.VIDEO_HEIGHT,this.video.width=this.VIDEO_WIDTH,this.video.height=this.VIDEO_HEIGHT},c.prototype.updateCanvas=function(){var a=this;a.canvasContext.drawImage(a.video,0,0,this.VIDEO_WIDTH,this.VIDEO_HEIGHT),a.originalImageData=a.canvasContext.getImageData(0,0,this.VIDEO_WIDTH,this.VIDEO_HEIGHT);for(var b=0,c=a.imageDataBuffersN-1;c>b;b++)a.imageDataBuffers[b]=a.imageDataBuffers[b+1];a.imageDataBuffers[c]=a.canvasContext.createImageData(this.VIDEO_WIDTH,this.VIDEO_HEIGHT),a.imageDataBuffers[c].data.set(a.originalImageData.data),a.processor.processCircularBuffer(a.originalImageData,a.imageDataBuffers),a.performanceController.setFrameMark(),a.performanceController.control(),webkitRequestAnimationFrame(a.updateCanvas.bind(a))},c.prototype.on=function(a,b){this.attachedEvents[a]||(this.attachedEvents[a]=[]),this.attachedEvents[a].push(b)},c.prototype.trigger=function(a,b){if(this.attachedEvents[a])for(var c=0;c<this.attachedEvents[a].length;c++)if(!1===this.attachedEvents[a][c].apply(b[0]||this,b))return},a.MotionSensor=c}(window,document),function(){MotionSensor.Vector2=function(a,b){this.x=a,this.y=b},MotionSensor.Vector2.prototype.getDistance=function(a){return Math.sqrt(Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2))}}(window,document),function(){MotionSensor.Vector3=function(a,b,c){this.x=a,this.y=b,this.z=c},MotionSensor.Vector3.prototype.getDistance=function(a){return Math.sqrt(Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2)+Math.pow(this.z-a.z,2))},MotionSensor.Vector3.prototype.dotProduct=function(a){this.x*=a,this.y*=a,this.z*=a}}(window,document),function(){MotionSensor.Vector4=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.t=d},MotionSensor.Vector4.prototype.getDistance=function(a){return Math.sqrt(.5*Math.pow(this.x-a.x,2)+.5*Math.pow(this.y-a.y,2)+10*Math.pow(this.z-a.z,2)+10*Math.pow(this.t-a.t,2))},MotionSensor.Vector4.prototype.dotProduct=function(a){this.x*=a,this.y*=a,this.z*=a,this.t*=a}}(window,document),function(){MotionSensor.Pixel=function(a,b){this.position=a,this.color=b}}(window,document),function(){MotionSensor.PerformanceController=function(a){this.motionSensor=a,this.timeMarksN=60,this.timeMarks=[0,0,0,0,0,0],this.votes=0,this.EXPECTED_FPS=30,this.fpsByScale={}},MotionSensor.PerformanceController.prototype.setFrameMark=function(){for(var a=0,b=this.timeMarksN-1;b>a;a++)this.timeMarks[a]=this.timeMarks[a+1];this.timeMarks[this.timeMarksN-1]=Date.now()},MotionSensor.PerformanceController.prototype.getFPS=function(){for(var a=0,b=0,c=this.timeMarksN-1;c>b;b++)a+=(this.timeMarks[b+1]-this.timeMarks[b])/1e3/c;return fps=Math.floor(1/a*100)/100,this.fpsByScale[this.motionSensor.scale.toString()]=fps,fps},MotionSensor.PerformanceController.prototype.control=function(){var a=this.getFPS();if(a<this.EXPECTED_FPS?this.votes--:this.votes++,this.motionSensor.trigger("fps:change",[a,this.motionSensor.scale]),this.motionSensor.options.fpsControlEnabled){var b;this.votes<-90?b=this.motionSensor.scale-.25:this.votes>90&&(b=this.motionSensor.scale+.25),(b&&!this.fpsByScale[b]||Math.abs(this.fpsByScale[b]-this.EXPECTED_FPS)<Math.abs(this.fpsByScale[this.motionSensor.scale]-this.EXPECTED_FPS))&&(console.log("MotionSensor: switch to scale",b," - fps map",this.fpsByScale),this.motionSensor.setScale(b),this.votes=0)}}}(window,document),function(){MotionSensor.Cluster=function(a){for(k in a)a.hasOwnProperty(k)&&(this[k]=a[k])},MotionSensor.Cluster.randomPointColors=[];for(var a,b,c,e=0;100>e;e++)a=Math.floor(255*Math.random()),b=Math.floor(255*Math.random()),c=Math.floor(255*Math.random()),MotionSensor.Cluster.randomPointColors.push("rgba("+a+", "+b+", "+c+", 0.6)");MotionSensor.Cluster.upsertArrayFromPoints_HCluster=function(a,b){if(b.forEach(function(a){a.vector=[a.position.x,a.position.y]}),!b.length)return[];clusterfck.hcluster(b)},MotionSensor.Cluster.upsertArrayFromPoints_KMeans=function(){},MotionSensor.Cluster.upsertArrayFromPoints=function(a,b,c,f,g){{var h,i,j,k,m,n,o,p=c,q=d=0,r=0,s=[],t=0,u=3,v=70;VIDEO_WIDTH=f.VIDEO_WIDTH,VIDEO_HEIGHT=f.VIDEO_HEIGHT}for(o=0;p>o;o++)if(n=a[o]){var w=new MotionSensor.Pixel(n.centroid,n.rgbFloat);b=b.concat([w,w,w])}for(t=0;u>t;t++){for(o=0;p>o;o++)0===t?a[o]?(a[o].rgbFloat.dotProduct(.8),s.push(a[o])):(i=Math.floor(Math.random()*VIDEO_WIDTH),j=Math.floor(Math.random()*VIDEO_HEIGHT),2===g&&(k=Math.random(),m=Math.random()),s.push(new MotionSensor.Cluster({id:o,centroid:2!==g?new MotionSensor.Vector2(i,j):new MotionSensor.Vector4(i,j,k,m),versor:new MotionSensor.Vector2(1,0),modulus:0,points:[],pixels:[],boundaryPointIndices:[],acum:[0,0],rgbFloat:new MotionSensor.Vector3(0,0,0),debugColor:MotionSensor.Cluster.randomPointColors[o]}))):(s[o].centroid.x=s[o].acum[0]/s[o].points.length,s[o].centroid.y=s[o].acum[1]/s[o].points.length,s[o].points=[],s[o].pixels=[],s[o].boundaryPointIndices=[],s[o].acum=[0,0]);for(e=0,l=b.length;l>e;e++)if(h=b[e]){for(q=Number.MAX_VALUE,r=0,o=0;p>o;o++)(d=h.position.getDistance(s[o].centroid))<q&&(q=d,r=o);(t!==u-1||v>q)&&s[r]&&(s[r].points.push(h.position),s[r].pixels.push(h),s[r].acum[0]+=h.position.x,s[r].acum[1]+=h.position.y,s[r].rgbFloat.x+=h.color.x/l,s[r].rgbFloat.y+=h.color.y/l,s[r].rgbFloat.z+=h.color.z/l)}}return s}}(window,document),function(){var a=function(a,b,c){return Math.sqrt(Math.pow(a[c+0]-b[c+0],2)+Math.pow(a[c+1]-b[c+1],2)+Math.pow(a[c+2]-b[c+2],2))};MotionSensor.Processor=function(a){this.motionSensor=a,this.context=a.canvasContext,this.i=0,this.clustersBuffer=[],this.convexHull=new a.constructor.ConvexHull,this.superClustersBuffer=[]},MotionSensor.Processor.prototype.processCircularBuffer=function(b,c){this.i++;var d=c.length,e=this.context,f=b,g=(f.data,c[d-1]),h=g.data,i=h.length,j=60,k=4,l=120,m=0,n=t=x=y=0,o=VIDEO_WIDTH=this.motionSensor.VIDEO_WIDTH,p=(VIDEO_HEIGHT=this.motionSensor.VIDEO_HEIGHT,this.motionSensor.options.totalClusters),q=[],r=[];for(n=0;i>n;n+=4){m=255;for(var s=0,t=d-1;t>s;s++)a(c[s].data,c[s+1].data,n)<j&&(m-=255/t);x=n/4%o,y=parseInt(n/4/o),this.i>d&&!(x%k)&&!(y%k)&&m>l&&r.push(new MotionSensor.Pixel(new MotionSensor.Vector2(x,y),new MotionSensor.Vector3(h[n+0],h[n+1],h[n+2])))}q=MotionSensor.Cluster.upsertArrayFromPoints(this.clustersBuffer,r,p,this.motionSensor),e.putImageData(c[d-1],0,0);for(var s=0,p=q.length;p>s;s++){var u=q[s];if(!(u.points.length<3)&&(u.boundaryPointIndices=this.convexHull.getGrahamScanPointIndices(u.points),u.boundaryPointIndices&&u.boundaryPointIndices.length>0)){var v,w,z,A,B,C,D,E,F=cy=countx=county=0,G=30,H=0;for(n=0,t=u.points.length;t>n;n++){for(x=u.points[n].x,y=u.points[n].y,C=c[d-2].data,lastpx=c[d-1].data,B=4*(y*o+x),D=[lastpx[B+0],lastpx[B+1],lastpx[B+2]],F=cy=0,z=0;G>z&&(v=x+z,B=4*(y*o+v),E=[C[B+0],C[B+1],C[B+2]],a(D,E,0)<50);z++)F++;for(z=0;z>-G&&(v=x+z,B=4*(y*o+v),E=[C[B+0],C[B+1],C[B+2]],a(D,E,0)<50);z--)F--;for(A=0;G>A&&(w=y+A,B=4*(w*o+x),E=[C[B+0],C[B+1],C[B+2]],a(D,E,0)<50);A++)cy++;for(A=0;A>-G&&(w=y+A,B=4*(w*o+x),E=[C[B+0],C[B+1],C[B+2]],a(D,E,0)<50);A--)cy--;countx+=F,county+=cy,H++}u.modulus=Math.sqrt(countx*countx+county*county),u.modulus?(u.versor.x=-countx/u.modulus,u.versor.y=-county/u.modulus):(u.versor.x=1,u.versor.y=0),u.modulus*=.03/this.motionSensor.scale,this.clustersBuffer[s]&&(u.centroid.x=.5*(u.centroid.x+this.clustersBuffer[s].centroid.x),u.centroid.y=.5*(u.centroid.y+this.clustersBuffer[s].centroid.y)),this.clustersBuffer[s]=u}}this.motionSensor.trigger("processor:compute",[this.clustersBuffer,this.context,1])}}(window,document),function(){var a=function(a,b,c){return Math.sqrt(Math.pow(a[c+0]-b[c+0],2)+Math.pow(a[c+1]-b[c+1],2)+Math.pow(a[c+2]-b[c+2],2))};MotionSensor.Processor2ClusterLevels=function(a){this.motionSensor=a,this.context=a.canvasContext,this.i=0,this.clustersBuffer=[],this.convexHull=new a.constructor.ConvexHull,this.superClustersBuffer=[]},MotionSensor.Processor2ClusterLevels.prototype.processCircularBuffer=function(b,c){this.i++;var d=c.length,e=this.context,f=b,g=(f.data,c[d-1]),h=g.data,i=h.length,j=60,k=4,l=120,m=0,n=t=x=y=0,o=VIDEO_WIDTH=this.motionSensor.VIDEO_WIDTH,p=(VIDEO_HEIGHT=this.motionSensor.VIDEO_HEIGHT,this.motionSensor.options.totalClusters),q=[],r=[];for(n=0;i>n;n+=4){m=255;for(var s=0,t=d-1;t>s;s++)a(c[s].data,c[s+1].data,n)<j&&(m-=255/t);x=n/4%o,y=parseInt(n/4/o),this.i>d&&!(x%k)&&!(y%k)&&m>l&&r.push(new MotionSensor.Pixel(new MotionSensor.Vector2(x,y),new MotionSensor.Vector3(h[n+0],h[n+1],h[n+2])))}q=MotionSensor.Cluster.upsertArrayFromPoints(this.clustersBuffer,r,p,this.motionSensor),e.putImageData(c[d-1],0,0);for(var s=0,p=q.length;p>s;s++){var u=q[s];if(!(u.points.length<3)&&(u.boundaryPointIndices=this.convexHull.getGrahamScanPointIndices(u.points),u.boundaryPointIndices&&u.boundaryPointIndices.length>0)){var v,w,z,A,B,C,D,E,F=cy=countx=county=0,G=30,H=0;for(n=0,t=u.points.length;t>n;n++){for(x=u.points[n].x,y=u.points[n].y,C=c[d-2].data,lastpx=c[d-1].data,B=4*(y*o+x),D=[lastpx[B+0],lastpx[B+1],lastpx[B+2]],F=cy=0,z=0;G>z&&(v=x+z,B=4*(y*o+v),E=[C[B+0],C[B+1],C[B+2]],a(D,E,0)<50);z++)F++;for(z=0;z>-G&&(v=x+z,B=4*(y*o+v),E=[C[B+0],C[B+1],C[B+2]],a(D,E,0)<50);z--)F--;for(A=0;G>A&&(w=y+A,B=4*(w*o+x),E=[C[B+0],C[B+1],C[B+2]],a(D,E,0)<50);A++)cy++;for(A=0;A>-G&&(w=y+A,B=4*(w*o+x),E=[C[B+0],C[B+1],C[B+2]],a(D,E,0)<50);A--)cy--;countx+=F,county+=cy,H++}u.modulus=Math.sqrt(countx*countx+county*county),u.modulus?(u.versor.x=-countx/u.modulus,u.versor.y=-county/u.modulus):(u.versor.x=1,u.versor.y=0),u.modulus*=.03/this.motionSensor.scale,this.clustersBuffer[s]&&(u.centroid.x=.5*(u.centroid.x+this.clustersBuffer[s].centroid.x),u.centroid.y=.5*(u.centroid.y+this.clustersBuffer[s].centroid.y)),this.clustersBuffer[s]=u}}if(this.motionSensor.trigger("processor:compute",[this.clustersBuffer,this.context,1]),this.i>30){this.superPoints=this.clustersBuffer.map(function(a){return new MotionSensor.Pixel(new MotionSensor.Vector4(a.centroid.x,a.centroid.y,a.versor.x*a.modulus,a.versor.y*a.modulus),new MotionSensor.Vector3(Math.floor(a.rgbFloat.x),Math.floor(a.rgbFloat.y),Math.floor(a.rgbFloat.z)))}),this.superClustersBuffer=MotionSensor.Cluster.upsertArrayFromPoints(this.superClustersBuffer,this.superPoints,6,this.motionSensor,2);var I=this;this.superClustersBuffer.forEach(function(a){a.boundaryPointIndices=I.convexHull.getGrahamScanPointIndices(a.points)}),this.motionSensor.trigger("processor:compute",[this.superClustersBuffer,this.context,2])}}}(window,document),function(){MotionSensor.ConvexHull=function(){this.ccw=function(a,b,c){return this.points[a]&&this.points[b]&&this.points[c]?(this.points[b].x-this.points[a].x)*(this.points[c].y-this.points[a].y)-(this.points[b].y-this.points[a].y)*(this.points[c].x-this.points[a].x):void 0},this.angle=function(a,b){return Math.atan((this.points[b].y-this.points[a].y)/(this.points[b].x-this.points[a].x))},this.distance=function(a,b){return(this.points[b].x-this.points[a].x)*(this.points[b].x-this.points[a].x)+(this.points[b].y-this.points[a].y)*(this.points[b].y-this.points[a].y)},this.getGrahamScanPointIndices=function(a){if(this.indices=[],!(a.length<3)){this.points=a;for(var b=0,c=1;c<this.points.length;c++)this.points[c].y==this.points[b].y?this.points[c].x<this.points[b].x&&(b=c):this.points[c].y<this.points[b].y&&(b=c);var d=new Array,e=0,f=0;for(c=0;c<this.points.length;c++)c!=b&&(e=this.angle(b,c),0>e&&(e+=Math.PI),f=this.distance(b,c),d.push(new this.Point(c,e,f)));d.sort(function(a,b){return a.compare(b)});var g=new Array(this.points.length+1),h=2;for(c=0;c<this.points.length;c++)c!=b&&(g[h]=d[h-2].index,h++);g[0]=g[this.points.length],g[1]=b;var i,j=2;for(c=3;c<=this.points.length;c++){for(;this.ccw(g[j-1],g[j],g[c])<=0;)j--;j++,i=g[c],g[c]=g[j],g[j]=i}for(this.indices=new Array(j),c=0;j>c;c++)this.indices[c]=g[c+1];return this.indices}}},MotionSensor.ConvexHull.prototype.Point=function(a,b,c){this.index=a,this.angle=b,this.distance=c,this.compare=function(a){return this.angle<a.angle?-1:this.angle>a.angle?1:this.distance<a.distance?-1:this.distance>a.distance?1:0}}}(window,document);